<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Sistema Oficina Completo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#f5f7fb; --card:#fff; --text:#222; --muted:#6b7280;
      --primary:#2563eb; --primary-600:#1d4ed8; --border:#e5e7eb; --ok:#16a34a; --err:#dc2626;
    }
    * { box-sizing:border-box; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text); }
    .container { max-width:1100px; margin:32px auto; padding:0 16px; }
    .tabs { display:flex; gap:8px; }
    .tab-btn { flex:1; padding:14px 12px; border:1px solid var(--border); background:#fff; border-radius:10px; font-weight:600; cursor:pointer; }
    .tab-btn.active { background:var(--primary); color:#fff; border-color:var(--primary); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; margin-top:16px; box-shadow:0 2px 8px rgba(0,0,0,.04); }
    h2 { margin:0 0 16px; font-size:20px; }
    .grid { display:grid; grid-template-columns:repeat(2,1fr); gap:14px; }
    label { font-size:12px; color:var(--muted); }
    input, textarea, select { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; outline:none; font:inherit; background:#fff; }
    textarea { min-height:84px; resize:vertical; }
    .row { display:flex; gap:10px; }
    .actions { display:flex; gap:10px; margin-top:12px; }
    .btn { border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.primary { background:var(--primary); color:#fff; }
    .btn.primary:hover { background:var(--primary-600); }
    .btn.muted { background:#eef2ff; color:#1e3a8a; }
    .alert { display:none; margin-top:10px; padding:10px 12px; border-radius:10px; font-size:14px; }
    .alert.ok { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .alert.err{ background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
    .content { display:none; }
    .content.active { display:block; }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { border:1px solid var(--border); padding:8px; text-align:left; vertical-align:top; }
    th { background:#f8fafc; }
    .cot { width:100%; min-height:70px; }
    @media (max-width: 780px) {
      .grid { grid-template-columns:1fr; }
      .tabs { flex-direction:column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- TABS -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="entrada">ENTRADA</button>
      <button class="tab-btn" data-tab="aguardando">AGUARDANDO</button>
      <button class="tab-btn" data-tab="emandamento">EM ANDAMENTO</button>
      <button class="tab-btn" data-tab="finalizado">FINALIZADO</button>
    </div>

    <!-- ENTRADA -->
    <section id="entrada" class="content active">
      <div class="card">
        <h2>Cadastro de Serviço</h2>
        <form id="cadastroForm">
          <div class="grid">
            <div>
              <label>DATA E HORA</label>
              <input type="datetime-local" name="DATA E HORA" required />
            </div>
            <div>
              <label>NOME</label>
              <input type="text" name="NOME" required />
            </div>

            <div>
              <label>CPF</label>
              <input type="text" name="CPF" required />
            </div>
            <div>
              <label>TELEFONE</label>
              <input type="text" name="TELEFONE" required />
            </div>

            <div>
              <label>ENDEREÇO</label>
              <input type="text" name="ENDEREÇO" />
            </div>
            <div>
              <label>NÚMERO</label>
              <input type="text" name="NÚMERO" />
            </div>

            <div>
              <label>BAIRRO</label>
              <input type="text" name="BAIRRO" />
            </div>
            <div>
              <label>CIDADE</label>
              <input type="text" name="CIDADE" />
            </div>

            <div>
              <label>UF</label>
              <input type="text" name="UF" />
            </div>
            <div>
              <label>VEÍCULO</label>
              <input type="text" name="VEÍCULO" />
            </div>

            <div>
              <label>KM INICIAL</label>
              <input type="text" name="KM INICIAL" />
            </div>
            <div>
              <label>PLACA</label>
              <input type="text" name="PLACA" />
            </div>

            <div>
              <label>ANO</label>
              <input type="text" name="ANO" />
            </div>
            <div>
              <label>MOTOR</label>
              <input type="text" name="MOTOR" />
            </div>

            <div>
              <label>MODELO</label>
              <input type="text" name="MODELO" />
            </div>
            <div>
              <label>PROBLEMA APONTADO</label>
              <input type="text" name="PROBLEMA APONTADO" />
            </div>

            <div>
              <label>KM FINAL</label>
              <input type="text" name="KM FINAL" />
            </div>
            <div>
              <label>OBSERVAÇÕES</label>
              <input type="text" name="OBSERVAÇÕES" />
            </div>
          </div>

          <label style="display:block;margin-top:10px;">COTAÇÃO</label>
          <textarea name="COTAÇÃO" placeholder="Itens, valores, mão de obra..."></textarea>

          <div class="actions">
            <button class="btn primary" type="submit">Enviar</button>
            <button class="btn muted" type="button" id="limparBtn">Limpar</button>
          </div>

          <div id="okMsg"  class="alert ok">Dados enviados com sucesso!</div>
          <div id="errMsg" class="alert err">Erro ao enviar. Tente novamente.</div>
        </form>
      </div>
    </section>

    <!-- AGUARDANDO (placeholder) -->
    <section id="aguardando" class="content">
      <div class="card"><h2>Serviços Aguardando</h2><p>em breve…</p></div>
    </section>

    <!-- EM ANDAMENTO -->
    <section id="emandamento" class="content">
      <div class="card">
        <h2>Serviços em Andamento</h2>
        <table>
          <thead>
            <tr>
              <th>Data e Hora</th><th>Nome</th><th>CPF</th><th>Telefone</th>
              <th>Endereço</th><th>Número</th><th>Bairro</th><th>Cidade</th><th>UF</th>
              <th>Veículo</th><th>KM Inicial</th><th>Placa</th><th>Ano</th><th>Motor</th>
              <th>Modelo</th><th>Problema Apontado</th><th>KM Final</th><th>Observações</th>
              <th>Cotação</th><th>Ações</th>
            </tr>
          </thead>
          <tbody id="emandamentoTable"></tbody>
        </table>
      </div>
    </section>

    <!-- FINALIZADO (placeholder) -->
    <section id="finalizado" class="content">
      <div class="card"><h2>Serviços Finalizados</h2><p>em breve…</p></div>
    </section>
  </div>

  <script>
    // 1) COLE AQUI A URL DO SEU WEB APP (implantado no Apps Script)
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwsc5_8uZVMoIrNB4jbyIpAa1NbUslHJKHNeU_sNI0e3Ddtrmrt0IXbumn8LjjUzca1BA/exec';

    // ==== navegação de abas ====
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');

        if (btn.dataset.tab === 'emandamento') carregarEmAndamento();
      });
    });

    // ==== ENVIAR CADASTRO (sem CORS, via FormData) ====
    const form = document.getElementById('cadastroForm');
    const okMsg  = document.getElementById('okMsg');
    const errMsg = document.getElementById('errMsg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      okMsg.style.display = 'none';
      errMsg.style.display = 'none';

      try {
        const fd = new FormData(form); // NÃO define Content-Type => evita preflight
        const res = await fetch(scriptURL, { method:'POST', body: fd });
        const data = await safeJson(res);

        if (data && data.status === 'success') {
          okMsg.style.display = 'block';
          form.reset();
        } else {
          errMsg.style.display = 'block';
        }
      } catch (err) {
        console.error(err);
        errMsg.style.display = 'block';
      }
    });

    document.getElementById('limparBtn').addEventListener('click', () => {
      form.reset();
      okMsg.style.display = 'none';
      errMsg.style.display = 'none';
    });

    // ==== CARREGAR EM ANDAMENTO ====
    async function carregarEmAndamento() {
      const tbody = document.getElementById('emandamentoTable');
      tbody.innerHTML = '<tr><td colspan="20">Carregando…</td></tr>';
      try {
        const res  = await fetch(scriptURL); // GET => lista EM ANDAMENTO
        const list = await safeJson(res);
        if (!Array.isArray(list)) throw new Error('Resposta inválida');

        tbody.innerHTML = '';
        list.forEach((item, index) => {
          const tr = document.createElement('tr');
          const cols = [
            'DATA E HORA','NOME','CPF','TELEFONE','ENDEREÇO','NÚMERO','BAIRRO','CIDADE','UF',
            'VEÍCULO','KM INICIAL','PLACA','ANO','MOTOR','MODELO','PROBLEMA APONTADO',
            'KM FINAL','OBSERVAÇÕES'
          ];
          cols.forEach(key => {
            const td = document.createElement('td');
            td.textContent = item[key] ?? '';
            tr.appendChild(td);
          });

          // COTAÇÃO editável
          const cotTd = document.createElement('td');
          const ta = document.createElement('textarea');
          ta.className = 'cot';
          ta.value = item['COTAÇÃO'] || '';
          ta.addEventListener('change', () => atualizarCotacao(index + 2, ta.value)); // +2 (cabeçalho)
          cotTd.appendChild(ta);
          tr.appendChild(cotTd);

          // Ações
          const acTd = document.createElement('td');
          const btn = document.createElement('button');
          btn.className = 'btn muted';
          btn.textContent = '…';
          btn.title = 'Mais ações em breve';
          acTd.appendChild(btn);
          tr.appendChild(acTd);

          tbody.appendChild(tr);
        });

        if (list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="20">Nenhum registro em andamento.</td></tr>';
        }
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="20">Erro ao carregar dados.</td></tr>';
      }
    }

    // ==== ATUALIZAR COTAÇÃO ====
    async function atualizarCotacao(linha, novaCotacao) {
      try {
        const body = new URLSearchParams({
          action: 'atualizarCotacao',
          linha: String(linha),
          novaCotacao: String(novaCotacao ?? '')
        });
        const res = await fetch(scriptURL, { method:'POST', body });
        const data = await safeJson(res);
        if (data?.status !== 'success') throw new Error('Falha ao atualizar');
        console.log('Cotação atualizada!');
      } catch (err) {
        console.error('Erro ao atualizar cotação:', err);
        alert('Não foi possível atualizar a cotação. Tente novamente.');
      }
    }

    // util: tenta ler JSON com fallback
    async function safeJson(res){
      const text = await res.text();
      try { return JSON.parse(text); } catch { return null; }
    }
  </script>
</body>
</html>
